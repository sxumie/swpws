<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Swap</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="process-body">
    <div class="process-wrapper">
        <header class="process-header">
            <div style="display: flex; gap: 10px;">
                <button onclick="window.location.href='landing.html'" class="back-btn">
                    <span>‚Üê</span> Back
                </button>
                <button onclick="window.location.href='history.html'" class="back-btn">
                    üìú History
                </button>
            </div>
        
            <div class="header-title-group">
                <h1>Swap Discussion</h1>
                <div id="status-badge" class="status-tag">Status: In Progress</div>
            </div>
        </header>

        <main class="process-main-grid">
            <section class="process-partners">
                <div class="partner-card" id="you-card">
                    <div class="avatar-wrapper">
                        <img src="images/coco.jpg" id="your-img" class="partner-img" alt="You">
                        <div class="user-badge">You</div>
                        <div id="your-finish-indicator" class="finish-indicator hidden">Ready to Finish ‚úÖ</div>
                    </div>
                    <h3 id="your-role">Me</h3>
                    <p id="your-skill" class="skill-text">Loading...</p>
                </div>
                
                <div class="swap-divider">
                    <div class="line"></div>
                    <div class="swap-icon">üîÑ</div>
                    <div class="line"></div>
                </div>

                <div class="partner-card" id="them-card">
                    <div class="avatar-wrapper">
                        <img src="images/coco.jpg" class="partner-img" id="them-img" alt="Partner">
                        <div class="user-badge partner">Partner</div>
                        <div id="them-finish-indicator" class="finish-indicator hidden">Ready to Finish ‚úÖ</div>
                    </div>
                    <h3 id="them-name">User</h3>
                    <div id="partner-status" class="online-indicator">
                        <span class="dot"></span> <small>Offline</small>
                    </div>
                    <p id="them-skill" class="skill-text">Loading...</p>
                </div>

                <div class="active-swaps-container">
                    <h4>All Active Swaps</h4>
                    <div id="swaps-list" class="swaps-list">
                        <p class="loading-text">Loading swaps...</p>
                    </div>
                </div>
            </section>

            <section class="process-details">
                <div class="details-box">
                    
                    <div class="details-header">
                        <h3>Collaboration Hub</h3>
                        <p>Coordinate your sessions and share learning resources.</p>
                    </div>

                    <div class="contact-card">
                        <div class="contact-icon">üìß</div>
                        <div class="contact-text">
                            <label>Partner Contact</label>
                            <span id="partner-email">Hidden until chat starts</span>
                        </div>
                    </div>

                    <!-- <div class="notes-area">
                        <label>Meeting Notes & Schedule</label>
                        <textarea id="swap-notes" placeholder="Write your meeting links, dates, or goals here..."></textarea>
                    </div> -->

                    <div class="messenger-container">
                        <div id="chat-history" class="chat-history">
                            <p class="loading-text">Loading conversation...</p>
                        </div>
                        
                        <div class="chat-input-area">
                            <input type="text" id="message-input" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
                            <button onclick="sendMessage()" class="send-btn">
                                <svg viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                            </button>
                        </div>
                    </div>

                    <button class="save-process-btn">
                        Save Discussion Details
                    </button>
                    
                    <button class="finish-deal-btn" onclick="finishSwap()" style="width: 100%; margin-top: 10px; background-color: #6366f1; color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 700; cursor: pointer;">
                       Finish Swap & Seal Deal
                    </button>
                    
                    <button class="btn-outline" onclick="cancelSwap()" style="width: 100%; margin-top: 10px; border-color: #ef4444; color: #ef4444; background: none; border: 1px solid; padding: 10px; border-radius: 16px; cursor: pointer;">
                        Cancel / Delete Swap
                    </button>
                </div>
            </section>
            <div id="ratingModal" class="modal hidden">
                <div class="modal-content">
                    <h3>Swap Complete! üéâ</h3>
                    <p>How was your experience with your partner?</p>
                    <div class="star-rating">
                        <span onclick="setRating(1)">‚≠ê</span>
                        <span onclick="setRating(2)">‚≠ê</span>
                        <span onclick="setRating(3)">‚≠ê</span>
                        <span onclick="setRating(4)">‚≠ê</span>
                        <span onclick="setRating(5)">‚≠ê</span>
                    </div>
                    <textarea id="ratingComment" placeholder="Write a quick thank you note..."></textarea>
                    <button class="btn-primary" onclick="submitRating()">Submit & Go Home</button>
                </div>
            </div>
        </main>
    </div>

</body>
</html>

<style>
/* Swapping Process Global Styles */
.process-body {
    background-color: var(--bg-body);
    color: var(--text-dark);
    font-family: 'Inter', system-ui, sans-serif;
    transition: background 0.3s ease;
}

.process-wrapper {
    max-width: 1100px;
    margin: 40px auto;
    padding: 20px;
}

/* Header Styling */
.process-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 40px;
}

.back-btn {
    background: var(--card-bg);
    border: 1px solid var(--border);
    padding: 10px 20px;
    border-radius: 12px;
    color: var(--text-dark);
    cursor: pointer;
    font-weight: 600;
    transition: 0.2s;
}

.back-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateX(-5px);
}

.header-title-group h1 {
    font-size: 1.8rem;
    margin-bottom: 5px;
}

.status-tag {
    background: rgba(99, 102, 241, 0.1);
    color: var(--primary);
    padding: 4px 12px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 700;
    display: inline-block;
}

/* Grid Layout */
.process-main-grid {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 30px;
}

/* Partner Cards */
.partner-card {
    background: var(--card-bg);
    padding: 30px;
    border-radius: 24px;
    text-align: center;
    border: 1px solid var(--border);
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}

.avatar-wrapper {
    position: relative;
    display: inline-block;
    margin-bottom: 15px;
}

.partner-img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid var(--bg-body);
    box-shadow: 0 0 0 3px var(--primary);
}

.user-badge {
    position: absolute;
    bottom: 0;
    right: 0;
    background: var(--primary);
    color: white;
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: bold;
}

.user-badge.partner { background: #10b981; }

.skill-text {
    color: var(--text-muted);
    font-size: 0.95rem;
    margin-top: 10px;
}

/* Visual Divider */
.swap-divider {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
}

.swap-divider .line {
    flex: 1;
    height: 1px;
    background: var(--border);
}

.swap-icon {
    font-size: 1.5rem;
    color: var(--primary);
    animation: rotate 10s linear infinite;
}

@keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* Details Box (Right Side) */
.details-box {
    background: var(--card-bg);
    padding: 40px;
    border-radius: 24px;
    border: 1px solid var(--border);
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}

.details-header h3 { font-size: 1.4rem; margin-bottom: 8px; }
.details-header p { color: var(--text-muted); margin-bottom: 30px; }

.contact-card {
    background: var(--bg-body);
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border-radius: 16px;
    margin-bottom: 25px;
}

.contact-icon { font-size: 1.5rem; }
.contact-text label { display: block; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
.contact-text span { font-weight: 600; color: var(--text-dark); }

.notes-area label {
    display: block;
    font-weight: 600;
    margin-bottom: 10px;
}

#swap-notes {
    width: 100%;
    min-height: 180px;
    padding: 20px;
    border-radius: 16px;
    border: 2px solid var(--border);
    background: var(--bg-body);
    color: var(--text-dark);
    font-family: inherit;
    resize: none;
    transition: 0.3s;
}

#swap-notes:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

.save-process-btn {
    width: 100%;
    margin-top: 25px;
    padding: 16px;
    background-color: #5fe5b8;
    color: rgb(59, 19, 120);
    border: none;
    border-radius: 16px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: 0.3s;
}

.save-process-btn:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2);
    background-color: #40b08b;
}

.finish-deal-btn {
    width: 100%;
    margin-top: 10px;
    background-color: #10b981; /* Nice emerald green */
    color: white;
    border: none;
    padding: 16px;
    border-radius: 16px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: 0.3s;
}

.finish-deal-btn:hover {
    background-color: #059669;
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
}

/*-------------- Small Scrollable box */

.active-swaps-container {
    background: var(--card-bg);
    margin-top: 20px;
    padding: 20px;
    border-radius: 24px;
    border: 1px solid var(--border);
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}

.active-swaps-container h4 {
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 15px;
    letter-spacing: 0.5px;
}

.swaps-list {
    max-height: 250px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-right: 5px;
}

/* Custom Scrollbar */
.swaps-list::-webkit-scrollbar { width: 5px; }
.swaps-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

.swap-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    background: var(--bg-body);
    border-radius: 12px;
    cursor: pointer;
    transition: 0.2s;
    border: 1px solid transparent;
}

.swap-item:hover {
    border-color: var(--primary);
    transform: translateX(5px);
}

.swap-item.active {
    background: rgba(99, 102, 241, 0.1);
    border-color: var(--primary);
}

.swap-item img {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
}

.swap-item-info span {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
}

.swap-item-info small {
    font-size: 0.7rem;
    color: var(--text-muted);
}

/* Messenger theme design */

.messenger-container {
    display: flex;
    flex-direction: column;
    height: 450px;
    background: var(--bg-body);
    border-radius: 20px;
    border: 1px solid var(--border);
    overflow: hidden;
}

.chat-history {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.msg {
    max-width: 75%;
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 0.95rem;
    line-height: 1.4;
    position: relative;
}

.msg.sent {
    align-self: flex-end;
    background: var(--primary);
    color: white;
    border-bottom-right-radius: 4px;
}

.msg.received {
    align-self: flex-start;
    background: var(--card-bg);
    color: var(--text-dark);
    border-bottom-left-radius: 4px;
    border: 1px solid var(--border);
}

.chat-input-area {
    padding: 15px;
    background: var(--card-bg);
    display: flex;
    gap: 10px;
    border-top: 1px solid var(--border);
}

#message-input {
    flex: 1;
    padding: 12px 20px;
    border-radius: 25px;
    border: 1px solid var(--border);
    outline: none;
    background: var(--bg-body);
}

.send-btn {
    background: var(--primary);
    color: white;
    border: none;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
}

.send-btn:hover { transform: scale(1.05); }

/* Online indicator */

.online-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    margin-top: 4px;
}
.dot {
    height: 9px;
    width: 9px;
    background-color: #94a3b8; /* Gray for offline */
    border-radius: 50%;
    transition: 0.3s;
}
.is-online .dot {
    background-color: #10b981; /* Green for online */
    box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
}
.is-online small { color: #10b981; font-weight: bold; }

/* Time Stamp */

/* Style for message timestamps */
.msg-time {
    display: block;
    font-size: 0.65rem;
    margin-top: 4px;
    opacity: 0.7;
    text-align: right;
}

.msg.received .msg-time {
    text-align: left;
}

/* Specific styling for the Online Status text */
#partner-status small {
    font-size: 0.75rem;
    color: var(--text-muted);
}

/* Rating UI */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}
.modal-content {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    text-align: center;
    max-width: 400px;
    width: 90%;
}
.star-rating span {
    font-size: 2rem;
    cursor: pointer;
    filter: grayscale(1);
    transition: 0.2s;
}
.star-rating span.active { filter: grayscale(0); transform: scale(1.2); }

/* Mobile Fix */
@media (max-width: 900px) {
    .process-main-grid { grid-template-columns: 1fr; }
    .process-header { flex-direction: column; align-items: flex-start; }
}

</style>

<!----------------------------------------------------------------------------------------------------------- -->

<script>
    const supabaseUrl = 'https://vegwfmtgrfllcfdoyqih.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlZ3dmbXRncmZsbGNmZG95cWloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4OTU5MjYsImV4cCI6MjA4NDQ3MTkyNn0.xxU7UPtQAPJQbeyLF0cpUTU1dwUjUB-ohWRQF1D_MLo';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const currentUser = JSON.parse(localStorage.getItem('swapwiseUser')) || null;
    const DEFAULT_AVATAR = 'images/coco.jpg';

    window.onload = async () => {
    if (!currentUser) {
        window.location.href = 'index.html';
        return;
    }
    await loadSwapDetails();
    await loadActiveSwaps();
    await loadMessages();
    subscribeToMessages();
    subscribeToSwapStatus(); // ADD THIS LINE
    trackPresence(); 

    const saveBtn = document.querySelector('.save-process-btn');
    if(saveBtn) saveBtn.onclick = saveNotes;
};

    let currentSwapData = null; // Global to store swap details

    async function loadSwapDetails() {
    const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
    if (!swapId) return;

    // Fixed Query: Joined profiles to get email and names
    const { data, error } = await _supabase
        .from('swap_requests')
        .select(`
            *,
            sender_profile:sender_id (id, full_name, avatar_url, email, teaching_skill),
            receiver_profile:receiver_id (id, full_name, avatar_url, email, teaching_skill)
        `)
        .eq('id', swapId)
        .single();

    if (error || !data) {
        console.error("Error loading swap:", error);
        return;
    }
    
    currentSwapData = data;

    // Update Indicators & Badge
    updateFinishUI(data);
    document.getElementById('status-badge').innerText = `Status: ${data.status}`;
    
    // Safety check for notes
    const notesEl = document.getElementById('swap-notes');
    if (notesEl) notesEl.value = data.notes || '';

    const isReceiver = data.receiver_id === currentUser.id;
    const partner = isReceiver ? data.sender_profile : data.receiver_profile;
    const you = isReceiver ? data.receiver_profile : data.sender_profile;

    // Populate UI
    document.getElementById('partner-email').innerText = partner.email || "No email provided";
    document.getElementById('them-name').innerText = partner.full_name;
    document.getElementById('them-name').dataset.userId = partner.id; 
    document.getElementById('them-skill').innerText = "Teaching: " + (partner.teaching_skill || 'N/A');
    document.getElementById('them-img').src = partner.avatar_url || DEFAULT_AVATAR;

    document.getElementById('your-skill').innerText = "Teaching: " + (you.teaching_skill || 'N/A');
    document.getElementById('your-img').src = you.avatar_url || DEFAULT_AVATAR;
}

    async function finishSwap() {
        const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
        
        if (confirm("Congratulations! Ready to mark this swap as completed?")) {
            const { error } = await _supabase
                .from('swap_requests')
                .update({ 
                    status: 'completed',
                    completed_at: new Date().toISOString() 
                })
                .eq('id', swapId);

            if (error) {
                alert("Error finishing deal: " + error.message);
            } else {
                alert("Deal Sealed! ü§ù Your swap is now archived.");
                localStorage.removeItem('activeSwapId');
                window.location.href = 'landing.html';
            }
        }
    }

    async function saveNotes() {
        const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
        const notesValue = document.getElementById('swap-notes').value;

        const { error } = await _supabase
            .from('swap_requests')
            .update({ notes: notesValue })
            .eq('id', swapId);

        if (error) alert("Save failed: " + error.message);
        else alert("Notes saved! ‚úÖ");
    }

    async function cancelSwap() {
        const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
        if (confirm("Permanently delete this swap?")) {
            const { error } = await _supabase.from('swap_requests').delete().eq('id', swapId);
            if (error) alert("Error: " + error.message);
            else {
                localStorage.removeItem('activeSwapId');
                window.location.href = 'landing.html';
            }
        }
    }

// Small Scrollable box function

async function loadActiveSwaps() {
    const currentSwapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
    const swapsList = document.getElementById('swaps-list'); // Ensure this matches your HTML ID

    if (!swapsList) return; // Safety check

    const { data, error } = await _supabase
        .from('swap_requests')
        .select(`
            id,
            sender_id,
            receiver_id,
            sender_profile:sender_id (full_name, avatar_url),
            receiver_profile:receiver_id (full_name, avatar_url)
        `)
        .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
        .eq('status', 'accepted'); // Automatically removes 'completed' swaps

    if (error) return console.error(error);

    swapsList.innerHTML = '';

    if (!data || data.length === 0) {
        swapsList.innerHTML = '<p style="font-size: 0.8rem; color: gray; padding: 10px;">No other active swaps.</p>';
        return;
    }

    data.forEach(swap => {
        const isReceiver = swap.receiver_id === currentUser.id;
        const partner = isReceiver ? swap.sender_profile : swap.receiver_profile;
        const isActive = swap.id == currentSwapId;

        const item = document.createElement('div');
        item.className = `swap-item ${isActive ? 'active' : ''}`;
        item.onclick = () => {
            localStorage.setItem('activeSwapId', swap.id);
            window.location.reload(); 
        };

        item.innerHTML = `
            <img src="${partner?.avatar_url || DEFAULT_AVATAR}" alt="avatar">
            <div class="swap-item-info">
                <span>${partner?.full_name || 'Unknown User'}</span>
                <small>${isActive ? 'Viewing Now' : 'Click to switch'}</small>
            </div>
        `;
        swapsList.appendChild(item);
    });
}

// Messenger Logic

async function loadMessages() {
    const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
    const { data, error } = await _supabase
        .from('swap_messages')
        .select('*')
        .eq('swap_id', swapId)
        .order('created_at', { ascending: true });

    if (error) return console.error(error);
    
    const container = document.getElementById('chat-history');
    container.innerHTML = '';
    data.forEach(msg => appendMessage(msg));
    container.scrollTop = container.scrollHeight;
}

function appendMessage(msg) {
    const container = document.getElementById('chat-history');
    const isSent = msg.sender_id === currentUser.id;
    const div = document.createElement('div');
    div.className = `msg ${isSent ? 'sent' : 'received'}`;
    
    // Create content and time elements
    const timeStr = formatTime(msg.created_at || new Date().toISOString());
    div.innerHTML = `
        <div class="msg-content">${msg.content}</div>
        <span class="msg-time">${timeStr}</span>
    `;
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

async function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');

    if (!content) return;

    const { error } = await _supabase
        .from('swap_messages')
        .insert([{ 
            swap_id: swapId, 
            sender_id: currentUser.id, 
            content: content 
        }]);

    if (error) alert("Error sending message");
    else input.value = '';
}

function handleKeyPress(e) {
    if (e.key === 'Enter') sendMessage();
}

// REAL-TIME: This makes messages appear instantly without refreshing
function subscribeToMessages() {
    const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
    _supabase
        .channel('public:swap_messages')
        .on('postgres_changes', { 
            event: 'INSERT', 
            schema: 'public', 
            table: 'swap_messages',
            filter: `swap_id=eq.${swapId}` 
        }, payload => {
            appendMessage(payload.new);
        })
        .subscribe();
}

// Active green logic
function trackPresence() {
    const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
    const channel = _supabase.channel(`presence:${swapId}`);

    channel
        .on('presence', { event: 'sync' }, () => {
            const partnerId = document.getElementById('them-name').dataset.userId;
            const state = channel.presenceState();
            
            // Find partner in the presence state
            const partnerData = Object.values(state).flat().find(user => user.user_id === partnerId);
            const isOnline = !!partnerData;
            
            const statusDiv = document.getElementById('partner-status');
            const statusText = statusDiv.querySelector('small');
            
            if (isOnline) {
                statusDiv.classList.add('is-online');
                statusText.innerText = 'Online Now';
            } else {
                statusDiv.classList.remove('is-online');
                // Optional: You can store a "last_seen" in your profiles table 
                // but for now, we'll show Offline.
                statusText.innerText = 'Offline';
            }
        })
        .subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                await channel.track({ 
                    user_id: currentUser.id,
                    online_at: new Date().toISOString() 
                });
            }
        });
}

// Time

function formatTime(isoString) {
    if (!isoString) return '';
    const date = new Date(isoString);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

//  Both party need to accept logic

async function confirmFinishSwap(swapId, role) {
    const updateData = {};
    if (role === 'sender') updateData.sender_finished = true;
    else updateData.receiver_finished = true;

    // 1. Update confirmation in Supabase
    const { data, error } = await _supabase
        .from('swap_requests')
        .update(updateData)
        .eq('id', swapId)
        .select();

    if (error) return console.error(error);

    const swap = data[0];

    // 2. Check if BOTH are now finished
    if (swap.sender_finished && swap.receiver_finished) {
        // Complete the swap
        await _supabase
            .from('swap_requests')
            .update({ status: 'completed' })
            .eq('id', swapId);
        
        showRatingPopup(swapId, swap.sender_id === currentUser.id ? swap.receiver_id : swap.sender_id);
    } else {
        alert("Waiting for your partner to also click Finish...");
    }
}

// Rating logic

let currentRating = 0;
let activeSwapId = null;
let partnerId = null;

function setRating(n) {
    currentRating = n;
    const stars = document.querySelectorAll('.star-rating span');
    stars.forEach((s, i) => s.classList.toggle('active', i < n));
}

async function submitRating() {
    if (currentRating === 0) return alert("Please select a star rating!");
    const comment = document.getElementById('ratingComment').value;

    // 1. Save to history table
    const { error: historyError } = await _supabase
        .from('swap_history')
        .insert({
            swap_id: activeSwapId,
            user_id: currentUser.id,
            partner_id: partnerId,
            rating: currentRating,
            comment: comment
        });

    if (historyError) return alert("History Error: " + historyError.message);

    // 2. Clear Local Storage so the page doesn't try to reload this swap
    localStorage.removeItem('activeSwapId');
    localStorage.removeItem('currentSwapId');

    alert("Swap archived! Redirecting to history...");
    window.location.href = 'history.html';
}

function updateFinishUI(swap) {
    const isSender = swap.sender_id === currentUser.id;
    
    // Show checkmarks on cards
    const youFinished = isSender ? swap.sender_finished : swap.receiver_finished;
    const themFinished = isSender ? swap.receiver_finished : swap.sender_finished;

    document.getElementById('your-finish-indicator').classList.toggle('hidden', !youFinished);
    document.getElementById('them-finish-indicator').classList.toggle('hidden', !themFinished);

    // Disable the button once you've clicked it
    const finishBtn = document.querySelector('.finish-deal-btn');
    if (youFinished) {
        finishBtn.innerText = "Waiting for Partner...";
        finishBtn.disabled = true;
        finishBtn.style.opacity = "0.6";
        finishBtn.style.cursor = "not-allowed";
    }
}

async function finishSwap() {
    const swapId = currentSwapData.id;
    const isSender = currentSwapData.sender_id === currentUser.id;
    
    // Update local DB to show this user is finished
    const updateData = isSender ? { sender_finished: true } : { receiver_finished: true };

    const { data, error } = await _supabase
        .from('swap_requests')
        .update(updateData)
        .eq('id', swapId)
        .select()
        .single();

    if (error) return alert(error.message);

    // If both are now finished, the Realtime listener (below) will trigger the Rating Modal
    if (data.sender_finished && data.receiver_finished) {
        completeTheSwap(swapId);
    } else {
        updateFinishUI(data);
    }
}

async function completeTheSwap(swapId) {
    await _supabase.from('swap_requests').update({ status: 'completed' }).eq('id', swapId);
    
    // Show rating modal
    const modal = document.getElementById('ratingModal');
    modal.classList.remove('hidden');
    
    // Prepare data for the submitRating function
    activeSwapId = swapId;
    partnerId = currentSwapData.sender_id === currentUser.id ? currentSwapData.receiver_id : currentSwapData.sender_id;
}

function subscribeToSwapUpdates() {
    const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
    
    _supabase
        .channel('swap_completion')
        .on('postgres_changes', { 
            event: 'UPDATE', 
            schema: 'public', 
            table: 'swap_requests',
            filter: `id=eq.${swapId}` 
        }, payload => {
            const updatedSwap = payload.new;
            updateFinishUI(updatedSwap);
            
            // If the status just changed to completed, show modal to the other person
            if (updatedSwap.sender_finished && updatedSwap.receiver_finished) {
                completeTheSwap(updatedSwap.id);
            }
        })
        .subscribe();
}

function subscribeToSwapStatus() {
    const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
    
    _supabase
        .channel('swap_status_monitor')
        .on('postgres_changes', 
            { 
                event: 'UPDATE', 
                schema: 'public', 
                table: 'swap_requests', 
                filter: `id=eq.${swapId}` 
            }, 
            (payload) => {
                const updatedData = payload.new;
                
                // Update UI indicators (checkmarks) instantly
                updateFinishUI(updatedData);

                // If both are finished, show the rating modal to BOTH users instantly
                if (updatedData.sender_finished && updatedData.receiver_finished) {
                    activeSwapId = updatedData.id;
                    partnerId = updatedData.sender_id === currentUser.id ? updatedData.receiver_id : updatedData.sender_id;
                    
                    const modal = document.getElementById('ratingModal');
                    if(modal) modal.classList.remove('hidden');
                }
            }
        )
        .subscribe();
}
</script>