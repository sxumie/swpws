<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Swap</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="process-body">
    <div class="process-wrapper">
        <header class="process-header">
            <button onclick="window.location.href='landing.html'" class="back-btn">
                <span>‚Üê</span> Back
            </button>
            <div class="header-title-group">
                <h1>Swap Discussion</h1>
                <div id="status-badge" class="status-tag">Status: In Progress</div>
            </div>
        </header>

        <main class="process-main-grid">
            <section class="process-partners">
                <div class="partner-card" id="you-card">
                    <div class="avatar-wrapper">
                        <img src="images/coco.jpg" id="your-img" class="partner-img" alt="You">
                        <div class="user-badge">You</div>
                    </div>
                    <h3 id="your-role">Me</h3>
                    <p id="your-skill" class="skill-text">Loading...</p>
                </div>
                
                <div class="swap-divider">
                    <div class="line"></div>
                    <div class="swap-icon">üîÑ</div>
                    <div class="line"></div>
                </div>

                <div class="partner-card" id="them-card">
                    <div class="avatar-wrapper">
                        <img src="images/coco.jpg" class="partner-img" id="them-img" alt="Partner">
                        <div class="user-badge partner">Partner</div>
                    </div>
                    <h3 id="them-name">User</h3>
                    <p id="them-skill" class="skill-text">Loading...</p>
                </div>
            </section>

            <section class="process-details">
                <div class="details-box">
                    
                    <div class="details-header">
                        <h3>Collaboration Hub</h3>
                        <p>Coordinate your sessions and share learning resources.</p>
                    </div>

                    <div class="contact-card">
                        <div class="contact-icon">üìß</div>
                        <div class="contact-text">
                            <label>Partner Contact</label>
                            <span id="partner-email">Hidden until chat starts</span>
                        </div>
                    </div>

                    <div class="notes-area">
                        <label for="swap-notes">Meeting Notes & Schedule</label>
                        <textarea id="swap-notes" placeholder="Swap details like contacts or social. Respect each other."></textarea>
                    </div>

                    <button class="save-process-btn">
                        Save Discussion Details
                    </button>
                    
                    <button class="finish-deal-btn" onclick="finishSwap()" style="width: 100%; margin-top: 10px; background-color: #6366f1; color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 700; cursor: pointer;">
                       Finish Swap & Seal Deal
                    </button>
                    
                    <button class="btn-outline" onclick="cancelSwap()" style="width: 100%; margin-top: 10px; border-color: #ef4444; color: #ef4444; background: none; border: 1px solid; padding: 10px; border-radius: 16px; cursor: pointer;">
                        Cancel / Delete Swap
                    </button>
                </div>
            </section>
        </main>
    </div>

</body>
</html>

<style>
/* Swapping Process Global Styles */
.process-body {
    background-color: var(--bg-body);
    color: var(--text-dark);
    font-family: 'Inter', system-ui, sans-serif;
    transition: background 0.3s ease;
}

.process-wrapper {
    max-width: 1100px;
    margin: 40px auto;
    padding: 20px;
}

/* Header Styling */
.process-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 40px;
}

.back-btn {
    background: var(--card-bg);
    border: 1px solid var(--border);
    padding: 10px 20px;
    border-radius: 12px;
    color: var(--text-dark);
    cursor: pointer;
    font-weight: 600;
    transition: 0.2s;
}

.back-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateX(-5px);
}

.header-title-group h1 {
    font-size: 1.8rem;
    margin-bottom: 5px;
}

.status-tag {
    background: rgba(99, 102, 241, 0.1);
    color: var(--primary);
    padding: 4px 12px;
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 700;
    display: inline-block;
}

/* Grid Layout */
.process-main-grid {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 30px;
}

/* Partner Cards */
.partner-card {
    background: var(--card-bg);
    padding: 30px;
    border-radius: 24px;
    text-align: center;
    border: 1px solid var(--border);
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}

.avatar-wrapper {
    position: relative;
    display: inline-block;
    margin-bottom: 15px;
}

.partner-img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid var(--bg-body);
    box-shadow: 0 0 0 3px var(--primary);
}

.user-badge {
    position: absolute;
    bottom: 0;
    right: 0;
    background: var(--primary);
    color: white;
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: bold;
}

.user-badge.partner { background: #10b981; }

.skill-text {
    color: var(--text-muted);
    font-size: 0.95rem;
    margin-top: 10px;
}

/* Visual Divider */
.swap-divider {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
}

.swap-divider .line {
    flex: 1;
    height: 1px;
    background: var(--border);
}

.swap-icon {
    font-size: 1.5rem;
    color: var(--primary);
    animation: rotate 10s linear infinite;
}

@keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* Details Box (Right Side) */
.details-box {
    background: var(--card-bg);
    padding: 40px;
    border-radius: 24px;
    border: 1px solid var(--border);
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}

.details-header h3 { font-size: 1.4rem; margin-bottom: 8px; }
.details-header p { color: var(--text-muted); margin-bottom: 30px; }

.contact-card {
    background: var(--bg-body);
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border-radius: 16px;
    margin-bottom: 25px;
}

.contact-icon { font-size: 1.5rem; }
.contact-text label { display: block; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
.contact-text span { font-weight: 600; color: var(--text-dark); }

.notes-area label {
    display: block;
    font-weight: 600;
    margin-bottom: 10px;
}

#swap-notes {
    width: 100%;
    min-height: 180px;
    padding: 20px;
    border-radius: 16px;
    border: 2px solid var(--border);
    background: var(--bg-body);
    color: var(--text-dark);
    font-family: inherit;
    resize: none;
    transition: 0.3s;
}

#swap-notes:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

.save-process-btn {
    width: 100%;
    margin-top: 25px;
    padding: 16px;
    background-color: #5fe5b8;
    color: rgb(59, 19, 120);
    border: none;
    border-radius: 16px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: 0.3s;
}

.save-process-btn:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2);
    background-color: #40b08b;
}

.finish-deal-btn {
    width: 100%;
    margin-top: 10px;
    background-color: #10b981; /* Nice emerald green */
    color: white;
    border: none;
    padding: 16px;
    border-radius: 16px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: 0.3s;
}

.finish-deal-btn:hover {
    background-color: #059669;
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2);
}

/* Mobile Fix */
@media (max-width: 900px) {
    .process-main-grid { grid-template-columns: 1fr; }
    .process-header { flex-direction: column; align-items: flex-start; }
}
</style>

<!----------------------------------------------------------------------------------------------------------- -->

<script>
    const supabaseUrl = 'https://vegwfmtgrfllcfdoyqih.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlZ3dmbXRncmZsbGNmZG95cWloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4OTU5MjYsImV4cCI6MjA4NDQ3MTkyNn0.xxU7UPtQAPJQbeyLF0cpUTU1dwUjUB-ohWRQF1D_MLo';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const currentUser = JSON.parse(localStorage.getItem('swapwiseUser')) || null;
    const DEFAULT_AVATAR = 'images/coco.jpg';

    window.onload = async () => {
        if (!currentUser) {
            window.location.href = 'index.html';
            return;
        }
        await loadSwapDetails();
        
        const saveBtn = document.querySelector('.save-process-btn');
        if(saveBtn) saveBtn.onclick = saveNotes;
    };

    async function loadSwapDetails() {
        const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
        
        if (!swapId) {
            window.location.href = 'landing.html';
            return;
        }

        const { data, error } = await _supabase
            .from('swap_requests')
            .select(`
                id, notes, sender_id, receiver_id, status,
                sender_profile:sender_id (full_name, teaching_skill, avatar_url, email),
                receiver_profile:receiver_id (full_name, teaching_skill, avatar_url, email)
            `)
            .eq('id', swapId)
            .single();

        if (error || !data) return console.error("Load Error:", error);

        // Update UI Textarea
        document.getElementById('swap-notes').value = data.notes || '';
        document.getElementById('status-badge').innerText = `Status: ${data.status}`;

        // Determine who is who
        const isReceiver = data.receiver_id === currentUser.id;
        const partner = isReceiver ? data.sender_profile : data.receiver_profile;
        const you = isReceiver ? data.receiver_profile : data.sender_profile;

        // FIX: Display the actual email from the database
        document.getElementById('partner-email').innerText = partner.email || "No email provided";

        // Update Partner Info
        document.getElementById('them-name').innerText = partner.full_name;
        document.getElementById('them-skill').innerText = "Teaching: " + partner.teaching_skill;
        document.getElementById('them-img').src = partner.avatar_url || DEFAULT_AVATAR;

        // Update Your Info
        document.getElementById('your-skill').innerText = "Teaching: " + you.teaching_skill;
        document.getElementById('your-img').src = you.avatar_url || DEFAULT_AVATAR;
    }

    async function finishSwap() {
        const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
        
        if (confirm("Congratulations! Ready to mark this swap as completed?")) {
            const { error } = await _supabase
                .from('swap_requests')
                .update({ 
                    status: 'completed',
                    completed_at: new Date().toISOString() 
                })
                .eq('id', swapId);

            if (error) {
                alert("Error finishing deal: " + error.message);
            } else {
                alert("Deal Sealed! ü§ù Your swap is now archived.");
                localStorage.removeItem('activeSwapId');
                window.location.href = 'landing.html';
            }
        }
    }

    async function saveNotes() {
        const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
        const notesValue = document.getElementById('swap-notes').value;

        const { error } = await _supabase
            .from('swap_requests')
            .update({ notes: notesValue })
            .eq('id', swapId);

        if (error) alert("Save failed: " + error.message);
        else alert("Notes saved! ‚úÖ");
    }

    async function cancelSwap() {
        const swapId = localStorage.getItem('activeSwapId') || localStorage.getItem('currentSwapId');
        if (confirm("Permanently delete this swap?")) {
            const { error } = await _supabase.from('swap_requests').delete().eq('id', swapId);
            if (error) alert("Error: " + error.message);
            else {
                localStorage.removeItem('activeSwapId');
                window.location.href = 'landing.html';
            }
        }
    }
</script>